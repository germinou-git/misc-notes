## Solution A (much better)
Thanks to [u/zavin4c](https://www.reddit.com/user/zavin4c/) for sharing this solution [here](https://www.reddit.com/r/zfs/comments/1qcwdd0/zfs_on_top_of_luks_unable_to_cleanly_close_luks/?utm_source=share&utm_medium=web3x&utm_name=web3xcss&utm_term=1&utm_content=share_button).

Edit zfs-import-scan.service
```
/etc/systemd/system/zfs-import-scan.service.d/override.conf

[Unit]
#After=systemd-cryptsetup@hdd1_crypt.service systemd-cryptsetup@hdd2_crypt.service #seems redundant with the existing After=cryptsetup.target
#Wants=systemd-cryptsetup@hdd1_crypt.service systemd-cryptsetup@hdd2_crypt.service
Conflicts=shutdown.target
Before=shutdown.target
[Service]
ExecStop=-/usr/sbin/zpool export -a
```
### Note
Unmounting (e.g. of /home) starts after local-fs.target ("Local File Systems") has stopped and completes before local-fs-pre.target ("Preparation for Local File Systems") stops.

The following edit should ensure that ZFS attempts to unmount (and subsequently to export) *after* the relevant umounts have completed. It "corrects" the original `Before=local-fs.target`, which is a step too early.
```
# /etc/systemd/system/zfs-mount.service.d/override.conf
[Unit]
Before=local-fs-pre.target
```

## Solution B (more complicated; keeping for the record)
Please read the end of this post before you actually proceed, as you may want to start with steps 3 and 4.

### 1. Create and enable this service (after replacing `home-pool-new` with the name of your pool).
This imports your pool after mounting and decrypting are complete.

```
# /etc/systemd/system/zfs-import-home.service
[Unit]
Description=Import ZFS pool home-pool-new
Documentation=man:zpool(8)
DefaultDependencies=no

After=cryptsetup.target
After=multipathd.service
After=systemd-remount-fs.service
Before=zfs-import.target
#ConditionFileNotEmpty=/etc/zfs/zpool.cache
ConditionPathIsDirectory=/sys/module/zfs

[Service]
Type=oneshot
RemainAfterExit=yes
EnvironmentFile=-/etc/default/zfs
ExecStart=/usr/bin/zpool import home-pool-new

[Install]
WantedBy=zfs-import.target
```

### 2. Check that the `zfs-import.target` systemd target exists and looks like this
(I don't remember creating it)
```
# /usr/lib/systemd/system/zfs-import.target
[Unit]
Description=ZFS pool import target
Before=dracut-mount.service

[Install]
WantedBy=zfs.target
```
The pool should now be imported automagically on boot (if it's been exported before).
### 3. The default behaviour, and part of the issue, arises from the `systemd-cryptsetup@crypt_drive1.service` services
(one service per relevant drive, created by the system).

`# systemctl cat systemd-cryptsetup@crypt_drive1.service`
```
# /run/systemd/generator/systemd-cryptsetup@crypt_drive1.service
# Automatically generated by systemd-cryptsetup-generator
[Unit]
Description=Cryptography Setup for %I
Documentation=man:crypttab(5) man:systemd-cryptsetup-generator(8) man:systemd-cryptsetup@.s>
SourcePath=/etc/crypttab

DefaultDependencies=no
After=cryptsetup-pre.target systemd-udevd-kernel.socket systemd-tpm2-setup-early.service
Before=blockdev@dev-mapper-%i.target
Wants=blockdev@dev-mapper-%i.target
IgnoreOnIsolate=true
Conflicts=umount.target
Before=umount.target
Before=cryptsetup.target
BindsTo=dev-disk-by\x2duuid-uuid.device

[Service]
Type=oneshot
RemainAfterExit=yes
TimeoutSec=infinity
KeyringMode=shared
OOMScoreAdjust=500
ImportCredential=cryptsetup.*
ExecStart=/usr/bin/systemd-cryptsetup attach 'crypt_drive1' '/dev/disk/by-uuid/uuid
ExecStop=/usr/bin/systemd-cryptsetup detach 'crypt_drive1'
```

The last line tries to close the cryptsetup drive while it is still in use as part of a zfs pool.
So we just remove that line by overriding it with an empty ExecStop:

`# systemctl edit systemd-cryptsetup@crypt_drive1.service`
```
### Editing /etc/systemd/system/systemd-cryptsetup@crypt_drive1.service.d/override.conf
### Anything between here and the comment below will become the contents of the drop-in file
[Service]
ExecStop=
### Edits below this comment will be discarded
```
Instead of closing ("detaching") the cryptsetup drives as originally scheduled,
we export the pool and detach the drives via the unit defined next,
after all drives have been unmounted.

### 4. Create and enable the following service
(I don't think it existed on my system, not 100% sure...).
Replace `home-pool-new` with your pool name, and `crypt_drive1` with your encrypted drive name.
Add as many drives as necessary.
Would be better to have a separate service for the export and one service per drive, but this works for me...

```
# /etc/systemd/system/cryptsetup-detach.service
[Unit]
Description=Export home-pool-new and Detach cryptsetup drives
After=umount.target
Before=final.target
DefaultDependencies=no

[Service]
Type=oneshot
ExecStartPre=-systemd-cat zpool export home-pool-new
ExecStart=-systemd-cat /usr/bin/cryptsetup close crypt_drive1
ExecStart=-systemd-cat /usr/bin/cryptsetup status crypt_drive1 #Unnecessary, but the previous command is silent, so useful to check in journal
ExecStop=/usr/bin/true

[Install]
WantedBy=final.target
```
After drives are unmounted, and before the system enters the final shutdown step, we export the pool and close the cryptsetup drives.

### Note
The steps, 1 to 4, are ordered roughly according the the boot/unboot sequence. In practice, you may want to deal with steps 3 and 4 first. Once that is done and your system shutdowns gracefully, you can automatize the pool import via steps 1 and 2.
Don't forget to run # systemctl daemon-reload for the changes you made to be effective.
